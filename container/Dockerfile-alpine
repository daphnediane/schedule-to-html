
ARG OSLABEL="latest"
ARG OSNAME="alpine"
ARG USER_ID=1000
ARG USER_NAME=devel
ARG USER_SHELL="/bin/bash"

ARG GROUP_NAME=${USER_NAME}
ARG GROUP_ID=${USER_ID}

FROM ${OSNAME}:${OSLABEL} AS base

ARG OSLABEL
ARG OSNAME
ARG TARGETARCH

ARG CACHE_PREFIX="${OSNAME}-${OSLABEL}-${TARGETARCH}"
ARG CACHE_PKG_VAR="${CACHE_PREFIX}-apk"
ARG CACHE_CPANM="${CACHE_PREFIX}-cpanm"

# Setup apk and some base packages
RUN --mount=type=cache,id=${CACHE_PKG_VAR},target=/var/cache/apk,sharing=locked \
    ln -n -s -f /var/cache/apk /etc/apk/cache \
    && apk update \
    && apk add \
    docs \
    git \
    man-pages \
    mandoc \
    mandoc-apropos \
    shadow \
    zsh

FROM base AS initial-user-env

ARG GROUP_ID
ARG GROUP_NAME
ARG USER_ID
ARG USER_NAME
ARG USER_SHELL

# Create the user
RUN groupadd --gid "${GROUP_ID}" "${GROUP_NAME}" \
    && useradd --uid "${USER_ID}" --gid "${GROUP_ID}" -m "${USER_NAME}" -s "${USER_SHELL}" \
    && mkdir -m 0640 -p /etc/sudoers.d \
    && echo "${USER_NAME}" ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/"${USER_NAME}" \
    && chmod 0440 /etc/sudoers.d/"${USER_NAME}" \
    && mkdir -p \
    /home/"$USER_NAME"/.ssh \
    /home/"$USER_NAME"/bin \
    /home/vscode-server \
    /workspaces \
    && chmod -R go-rwx /root \
    && chown -R "$USER_NAME":"$GROUP_NAME" \
    /home/"$USER_NAME" \
    /home/vscode-server \
    /workspaces \
    && chmod -R go-rwx /home/"$USER_NAME"/.ssh \
    && chmod -R u+rwx /home/"$USER_NAME"/bin \
    && ln -n -s -f /home/vscode-server /home/"$USER_NAME"/.vscode-server \
    && git config --system push.default simple \
    && git config --system init.defaultBranch main

FROM initial-user-env AS add-packages

ARG CACHE_PKG_VAR

# Base applications
RUN --mount=type=cache,id=${CACHE_PKG_VAR},target=/var/cache/apk,sharing=locked \
    apk add \
    build-base \
    curl \
    diffutils \
    expat expat-dev \
    gpg \
    less \
    lighttpd \
    make \
    nodejs \
    npm \
    openssh-client-default openssh-keygen \
    openssl openssl-dev \
    procps-ng \
    rsync \
    sudo \
    tar \
    tmux \
    xz \
    zlib zlib-dev

FROM add-packages AS add-cpanm

ARG BUILDARCH
ARG CACHE_CPANM
ARG CACHE_PKG_VAR
ARG TARGETARCH

# Install perl, cpanm, and cpm
# Based on https://github.com/Perl/docker-perl/
# And issue #23/#24
WORKDIR /usr/src/perl
RUN --mount=type=cache,id=${CACHE_PKG_VAR},target=/var/cache/apk,sharing=locked \
    --mount=type=cache,id=${CACHE_CPANM},target=/root/.cpanm,sharing=locked \
    --mount=type=tmpfs,target=/tmp \
    apk add --virtual .build-deps \
    build-base \
    curl \
    dpkg dpkg-dev \
    expat expat-dev \
    make \
    openssl openssl-dev \
    procps \
    tar \
    wget \
    xz \
    zlib zlib-dev \
    && curl -fL https://cpan.metacpan.org/authors/id/H/HA/HAARG/perl-5.40.0.tar.gz -o perl-5.40.0.tar.gz \
    && echo 'c740348f357396327a9795d3e8323bafd0fe8a5c7835fc1cbaba0cc8dfe7161f *perl-5.40.0.tar.gz' | sha256sum -c - \
    && tar --strip-components=1 -xaf perl-5.40.0.tar.gz -C /usr/src/perl \
    && rm perl-5.40.0.tar.gz \
    && cat *.patch | patch -p1 \
    && gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)" \
    && archBits="$(dpkg-architecture --query DEB_BUILD_ARCH_BITS)" \
    && archFlag="$([ "$archBits" = '64' ] && echo '-Duse64bitall' || echo '-Duse64bitint')" \
    && ./Configure -Darchname="$gnuArch" "$archFlag" -Duseshrplib -Dvendorprefix=/usr/local  -des \
    && make -j$(nproc) \
    && { TEST_JOBS=$(nproc) make test_harness || [[ ${BUILDARCH} != ${TARGETARCH} ]]; } \
    && make install \
    && cd /usr/src \
    && curl -fLO https://www.cpan.org/authors/id/M/MI/MIYAGAWA/App-cpanminus-1.7047.tar.gz \
    && echo '963e63c6e1a8725ff2f624e9086396ae150db51dd0a337c3781d09a994af05a5 *App-cpanminus-1.7047.tar.gz' | sha256sum -c - \
    && tar -xzf App-cpanminus-1.7047.tar.gz && cd App-cpanminus-1.7047 && perl bin/cpanm . && cd /root \
    && curl -fLO 'https://www.cpan.org/authors/id/C/CH/CHRISN/Net-SSLeay-1.94.tar.gz' \
    && echo '9d7be8a56d1bedda05c425306cc504ba134307e0c09bda4a788c98744ebcd95d *Net-SSLeay-1.94.tar.gz' | sha256sum -c - \
    && cpanm --from $PWD Net-SSLeay-1.94.tar.gz \
    && curl -fLO 'https://www.cpan.org/authors/id/S/SU/SULLR/IO-Socket-SSL-2.085.tar.gz' \
    && echo '95b2f7c0628a7e246a159665fbf0620d0d7835e3a940f22d3fdd47c3aa799c2e *IO-Socket-SSL-2.085.tar.gz' | sha256sum -c - \
    && SSL_CERT_DIR=/etc/ssl/certs cpanm --from $PWD IO-Socket-SSL-2.085.tar.gz \
    && curl -fL https://raw.githubusercontent.com/skaji/cpm/0.997017/cpm -o /usr/local/bin/cpm \
    # sha256 checksum is from docker-perl team, cf https://github.com/docker-library/official-images/pull/12612#issuecomment-1158288299
    && echo 'e3931a7d994c96f9c74b97d1b5b75a554fc4f06eadef1eca26ecc0bdcd1f2d11 */usr/local/bin/cpm' | sha256sum -c - \
    && chmod +x /usr/local/bin/cpm \
    && runDeps="$( \
    scanelf --needed --nobanner --recursive /usr/local \
    | awk '{ gsub(/,/, "\nso:", $2); print "so:" $2 }' \
    | sort -u \
    | xargs -r apk info --installed \
    | sort -u \
    | grep -v perl \
    )" \
    && apk add --virtual .perl-rundeps $runDeps make wget \
    && apk del .build-deps \
    && rm -fr /root/Net-SSLeay-1.94* /root/IO-Socket-SSL-2.085* /usr/src/perl /usr/src/App-cpanminus-1.7046* \
    && cpanm --version && cpm --version
WORKDIR /

FROM add-cpanm AS add-perl-modules

ARG CACHE_CPANM
ARG CACHE_PKG_VAR

# Some perl modules requiring special handling
# Archive::Zip requires full unzip, not busybox for testing
# IO::AIO - t/05_readdir.t  -- test fails so disable testing for now
RUN --mount=type=cache,id=${CACHE_PKG_VAR},target=/var/cache/apk,sharing=locked \
    --mount=type=cache,id=${CACHE_CPANM},target=/root/.cpanm,sharing=locked \
    apk add --virtual .test-deps unzip \
    && cpm install --global --test \
    Archive::Zip \
    && cpm install --global --no-test \
    IO::AIO \
    && apk del .test-deps \
    && cpm install --global --test \
    Carmel \
    Carton \
    common::sense \
    Date::Parse \
    Devel::NYTProf \
    Feature::Compat::Class \
    File::Slurp \
    HTML::Tiny \
    List::MoreUtils \
    Object::InsideOut \
    Perl::Critic \
    Perl::Critic::TooMuchCode \
    Perl::LanguageServer \
    Perl::Tidy \
    Readonly \
    Spreadsheet::ParseXLSX

FROM add-perl-modules AS user-env

ARG USER_NAME

# Set up VS Code directories
RUN true \
    && mkdir -p \
    /home/vscode-server \
    /workspaces \
    && chown -R "$USER_NAME":"$GROUP_NAME" \
    /home/vscode-server \
    /workspaces \
    && ln -n -s -f /home/vscode-server /home/"$USER_NAME"/.vscode-server

USER ${USER_NAME}
